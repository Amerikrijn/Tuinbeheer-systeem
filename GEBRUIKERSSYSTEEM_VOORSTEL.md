# Gebruikerssysteem Implementatie Voorstel
## Tuinbeheer-systeem ðŸŒ±ðŸ‘¥

### Overzicht
Dit document beschrijft de implementatie van een uitgebreid gebruikerssysteem voor het tuinbeheer-systeem, inclusief role-based access control (RBAC), email uitnodigingen, en gebruiker tracking.

---

## ðŸŽ¯ Doelstellingen

### Administrator Functionaliteit
- âœ… Gebruikers kunnen toevoegen via email uitnodigingen
- âœ… Alle huidige functionaliteit behouden (volledige toegang)
- âœ… Gebruikersbeheer dashboard
- âœ… Rollen en permissies beheren

### Gewone Gebruiker Functionaliteit  
- âœ… Alleen logboek entries bekijken/toevoegen
- âœ… Taken kunnen afvinken/voltooien
- âœ… Beperkte toegang (geen beheer functionaliteit)

### Tracking Functionaliteit
- âœ… Bij taken: wie heeft de taak uitgevoerd
- âœ… Bij logboek: wie heeft het item toegevoegd
- âœ… Audit trail voor alle acties

---

## ðŸ—ï¸ Technische Architectuur

### 1. Database Schema Uitbreidingen

#### Users Tabel
```sql
CREATE TABLE public.users (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL UNIQUE,
  full_name TEXT,
  avatar_url TEXT,
  role app_role NOT NULL DEFAULT 'user',
  status user_status NOT NULL DEFAULT 'pending',
  invited_by UUID REFERENCES public.users(id),
  invited_at TIMESTAMP WITH TIME ZONE,
  last_login TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Custom types
CREATE TYPE app_role AS ENUM ('admin', 'user');
CREATE TYPE user_status AS ENUM ('pending', 'active', 'inactive');
```

#### User Permissions Tabel
```sql
CREATE TABLE public.user_permissions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE,
  permission app_permission NOT NULL,
  granted_by UUID REFERENCES public.users(id),
  granted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Permissions enum
CREATE TYPE app_permission AS ENUM (
  'gardens.create', 'gardens.edit', 'gardens.delete',
  'plant_beds.create', 'plant_beds.edit', 'plant_beds.delete',
  'plants.create', 'plants.edit', 'plants.delete',
  'tasks.create', 'tasks.edit', 'tasks.delete', 'tasks.complete',
  'logbook.create', 'logbook.edit', 'logbook.delete',
  'users.invite', 'users.manage'
);
```

#### Bestaande Tabellen Uitbreiden
```sql
-- Tasks tabel uitbreiden
ALTER TABLE tasks ADD COLUMN completed_by UUID REFERENCES public.users(id);
ALTER TABLE tasks ADD COLUMN created_by UUID REFERENCES public.users(id);

-- Logbook entries uitbreiden  
ALTER TABLE logbook_entries ADD COLUMN created_by UUID REFERENCES public.users(id);
ALTER TABLE logbook_entries ADD COLUMN updated_by UUID REFERENCES public.users(id);

-- Gardens, plant_beds, plants uitbreiden voor ownership
ALTER TABLE gardens ADD COLUMN created_by UUID REFERENCES public.users(id);
ALTER TABLE plant_beds ADD COLUMN created_by UUID REFERENCES public.users(id);
ALTER TABLE plants ADD COLUMN created_by UUID REFERENCES public.users(id);
```

### 2. Supabase Auth Integratie

#### Custom Claims Setup
```sql
-- Auth Hook Function voor Role-Based Access
CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event jsonb)
RETURNS jsonb
LANGUAGE plpgsql
STABLE
AS $$
DECLARE
  claims jsonb;
  user_role app_role;
  user_permissions text[];
BEGIN
  -- Fetch user role
  SELECT role INTO user_role FROM public.users WHERE id = (event->>'user_id')::uuid;
  
  -- Fetch user permissions
  SELECT array_agg(permission::text) INTO user_permissions 
  FROM public.user_permissions 
  WHERE user_id = (event->>'user_id')::uuid;
  
  claims := event->'claims';
  
  IF user_role IS NOT NULL THEN
    claims := jsonb_set(claims, '{user_role}', to_jsonb(user_role));
    claims := jsonb_set(claims, '{permissions}', to_jsonb(user_permissions));
  END IF;
  
  event := jsonb_set(event, '{claims}', claims);
  RETURN event;
END;
$$;
```

#### Row Level Security Policies
```sql
-- RLS voor users tabel
CREATE POLICY "Users can view own profile" ON public.users 
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Admins can view all users" ON public.users 
  FOR SELECT USING (
    EXISTS(SELECT 1 FROM public.users WHERE id = auth.uid() AND role = 'admin')
  );

-- RLS voor tasks
CREATE POLICY "Users can view tasks" ON tasks FOR SELECT USING (true);
CREATE POLICY "Users can complete tasks" ON tasks 
  FOR UPDATE USING (auth.uid() IS NOT NULL)
  WITH CHECK (completed_by = auth.uid());

-- RLS voor logbook
CREATE POLICY "Users can create logbook entries" ON logbook_entries 
  FOR INSERT WITH CHECK (created_by = auth.uid());
```

### 3. Email Uitnodigingssysteem

#### Supabase Edge Function voor Uitnodigingen
```typescript
// functions/invite-user/index.ts
export default async function handler(req: Request) {
  const { email, role = 'user' } = await req.json();
  
  // Create user with invitation
  const { data: user, error } = await supabaseAdmin.auth.admin.createUser({
    email,
    user_metadata: { role, status: 'pending' }
  });
  
  if (error) throw error;
  
  // Send invitation email
  const { error: inviteError } = await supabaseAdmin.auth.admin.inviteUserByEmail(
    email, 
    { 
      redirectTo: `${process.env.SITE_URL}/auth/accept-invite`,
      data: { role, invited_by: currentUser.id }
    }
  );
  
  // Store in users table
  await supabaseAdmin.from('users').insert({
    id: user.id,
    email,
    role,
    status: 'pending',
    invited_by: currentUser.id,
    invited_at: new Date().toISOString()
  });
  
  return { success: true, user };
}
```

---

## ðŸŽ¨ Frontend Implementatie

### 1. Authenticatie Componenten
- **Login/Signup pagina's**
- **Accept Invitation pagina**
- **Password Reset flow**
- **User profiel management**

### 2. Admin Dashboard
```typescript
// components/admin/UserManagement.tsx
export function UserManagement() {
  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold">Gebruikersbeheer</h2>
        <InviteUserDialog />
      </div>
      
      <UsersList />
      <RolePermissionMatrix />
    </div>
  );
}
```

### 3. Role-based UI Components
```typescript
// hooks/usePermissions.ts
export function usePermissions() {
  const { user } = useAuth();
  
  const hasPermission = (permission: string) => {
    return user?.app_metadata?.permissions?.includes(permission) || 
           user?.app_metadata?.user_role === 'admin';
  };
  
  return { hasPermission };
}

// components/ProtectedComponent.tsx
export function ProtectedComponent({ 
  permission, 
  children 
}: { 
  permission: string; 
  children: React.ReactNode; 
}) {
  const { hasPermission } = usePermissions();
  
  if (!hasPermission(permission)) return null;
  
  return <>{children}</>;
}
```

### 4. Enhanced Task & Logbook Components
```typescript
// Task completion with user tracking
const completeTask = async (taskId: string) => {
  await supabase
    .from('tasks')
    .update({ 
      completed: true, 
      completed_at: new Date().toISOString(),
      completed_by: user.id 
    })
    .eq('id', taskId);
};

// Logbook entry with user info
const createLogEntry = async (entry: LogbookEntry) => {
  await supabase
    .from('logbook_entries')
    .insert({
      ...entry,
      created_by: user.id
    });
};
```

---

## ðŸ“‹ Implementatie Roadmap

### Fase 1: Core Authenticatie (Week 1-2)
- [ ] Database schema uitbreidingen
- [ ] Supabase Auth setup met Custom Claims
- [ ] Basic login/signup flow
- [ ] RLS policies implementeren

### Fase 2: Gebruikersbeheer (Week 3-4) 
- [ ] Email uitnodigingssysteem
- [ ] Admin dashboard voor gebruikersbeheer
- [ ] Role-based access control
- [ ] User profile management

### Fase 3: Enhanced Tracking (Week 5-6)
- [ ] Task completion tracking
- [ ] Logbook user attribution
- [ ] Audit trail implementatie
- [ ] Enhanced UI met user info

### Fase 4: Testing & Polish (Week 7-8)
- [ ] Unit tests voor auth flows
- [ ] Integration tests
- [ ] UI/UX improvements
- [ ] Documentation updates

---

## ðŸ”’ Beveiligingsoverwegingen

### Data Privacy
- GDPR compliance voor gebruikersgegevens
- Data minimalisatie principes
- Secure storage van PII

### Access Control
- Multi-factor authentication optie
- Session management
- Rate limiting voor API endpoints

### Audit & Compliance
- Comprehensive logging
- Data retention policies
- Regular security audits

---

## ðŸ“Š Verwachte Impact

### Voor Administrators
- âœ… Centraal gebruikersbeheer
- âœ… Volledige controle over permissies
- âœ… Audit trail voor alle acties
- âœ… Schaalbaarheid voor teams

### Voor Gebruikers
- âœ… Eenvoudige onboarding via email
- âœ… Personalized experience
- âœ… Duidelijke verantwoordelijkheden
- âœ… Veilige toegang

### Voor het Systeem
- âœ… Betere data integriteit
- âœ… Verbeterde security posture
- âœ… Compliance met moderne standards
- âœ… Foundation voor toekomstige features

---

## ðŸ’­ Volgende Stappen

1. **Goedkeuring** van dit voorstel
2. **Sprint planning** voor Fase 1
3. **Database migratie** voorbereiden
4. **Development environment** setup
5. **Team briefing** over nieuwe architectuur

---

*Dit voorstel biedt een robuuste, schaalbare oplossing voor gebruikersbeheer die perfect aansluit bij de huidige architectuur van het tuinbeheer-systeem.*