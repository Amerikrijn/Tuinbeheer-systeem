name: Daily Security Monitor

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  workflow_dispatch:

jobs:
  security-monitor:
    name: Security Monitoring
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run comprehensive security scan
        run: |
          echo "üîí Starting daily security scan..."
          npm run ci:security
          ./scripts/dast-scan.sh
          
      - name: Check for new vulnerabilities
        run: |
          echo "üì¶ Checking for new NPM vulnerabilities..."
          npm audit --audit-level moderate --json > audit-report.json
          
          VULNERABILITIES=$(cat audit-report.json | jq '.vulnerabilities | length' 2>/dev/null || echo "0")
          echo "Found $VULNERABILITIES vulnerabilities"
          
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "‚ùå Security vulnerabilities detected!"
            exit 1
          else
            echo "‚úÖ No new vulnerabilities found"
          fi
          
      - name: Security report
        run: |
          echo "## üîí Daily Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ All security checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- Security pattern scanning" >> $GITHUB_STEP_SUMMARY
          echo "- DAST vulnerability scan" >> $GITHUB_STEP_SUMMARY
          echo "- NPM dependency audit" >> $GITHUB_STEP_SUMMARY
          echo "- Banking standards compliance" >> $GITHUB_STEP_SUMMARY
          
      - name: Create security issue if vulnerabilities found
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = `## üö® Security Alert
            
            **Date:** ${new Date().toISOString()}
            **Type:** Daily Security Scan
            **Status:** ‚ùå Vulnerabilities detected
            
            ### Summary
            The daily security scan has detected new security vulnerabilities that require immediate attention.
            
            ### Action Required
            Please review the security scan results and address any identified vulnerabilities.
            
            ### Next Steps
            1. Review the security scan logs
            2. Update vulnerable dependencies
            3. Re-run security tests
            4. Verify all issues are resolved
            
            ---
            *This issue was automatically created by the security monitoring workflow*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Security Alert: Daily Scan Detected Vulnerabilities',
              body: issueBody,
              labels: ['security', 'urgent', 'automated'],
              assignees: ['Amerikrijn']
            });