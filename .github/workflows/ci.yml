name: CI/CD Pipeline

# Trigger workflow on feature branches and other development branches
on:
  push:
    branches: [ preview, develop, feature/*, fix/*, hotfix/* ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, preview, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'preview'
        type: choice
        options:
        - preview
        - staging
        - production

env:
  NODE_VERSION: '18'

jobs:
  # Security Check - Prevent direct pushes to main
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸš¨ Block Direct Push to Main
        run: |
          echo "âŒ DIRECT PUSH TO MAIN BLOCKED!"
          echo "ğŸš¨ Main branch is protected and requires a Pull Request"
          echo "ğŸ“‹ Please create a PR from a feature branch to preview first"
          echo "ğŸ”’ This is a security measure to prevent accidental deployments"
          exit 1

  # Lint and Test
  lint-and-test:
    name: ğŸ§ª Lint & Test
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Lint code
        run: npm run lint

      - name: ğŸ§ª Run tests
        run: npm run test

      - name: ğŸ—ï¸ Build project
        run: npm run build

  # Deploy to Preview (from feature branches)
  deploy-preview:
    name: ğŸš€ Deploy to Preview
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/preview'
    environment: preview
    needs: lint-and-test
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Preview
        run: |
          echo "ğŸš€ Deploying to Preview environment..."
          echo "ğŸ“‹ Branch: ${{ github.ref_name }}"
          echo "ğŸ”— Preview URL will be available after deployment"

  # Deploy to Preview (from preview branch)
  deploy-preview-main:
    name: ğŸš€ Deploy Preview to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/preview'
    environment: staging
    needs: lint-and-test
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy Preview to Staging
        run: |
          echo "ğŸš€ Deploying Preview to Staging environment..."
          echo "ğŸ“‹ This is the main preview deployment"

  # Deploy to Production (only from main via PR)
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'pull_request'
    environment: production
    needs: lint-and-test
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Production
        run: |
          echo "ğŸš€ Deploying to Production environment..."
          echo "ğŸ“‹ This deployment was triggered by a PR merge to main"

  # Notify on deployment
  notify:
    name: ğŸ“¢ Notify Team
    runs-on: ubuntu-latest
    if: always()
    needs: [lint-and-test, deploy-preview, deploy-preview-main, deploy-production]
    steps:
      - name: ğŸ“¢ Deployment Status
        run: |
          if [ "${{ needs.lint-and-test.result }}" == "success" ]; then
            echo "âœ… Lint & Test: SUCCESS"
          else
            echo "âŒ Lint & Test: FAILED"
          fi
          
          if [ "${{ needs.deploy-preview.result }}" == "success" ]; then
            echo "âœ… Preview Deploy: SUCCESS"
          elif [ "${{ needs.deploy-preview.result }}" == "skipped" ]; then
            echo "â­ï¸ Preview Deploy: SKIPPED"
          else
            echo "âŒ Preview Deploy: FAILED"
          fi
          
          if [ "${{ needs.deploy-preview-main.result }}" == "success" ]; then
            echo "âœ… Staging Deploy: SUCCESS"
          elif [ "${{ needs.deploy-preview-main.result }}" == "skipped" ]; then
            echo "â­ï¸ Staging Deploy: SKIPPED"
          else
            echo "âŒ Staging Deploy: FAILED"
          fi
          
          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "âœ… Production Deploy: SUCCESS"
          elif [ "${{ needs.deploy-production.result }}" == "skipped" ]; then
            echo "â­ï¸ Production Deploy: SKIPPED"
          else
            echo "âŒ Production Deploy: FAILED"
          fi
