name: Quality Gates Enforcement

on:
  pull_request:
    branches: [ main, preview, develop ]
  push:
    branches: [ main, preview, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  QUALITY_THRESHOLDS:
    TEST_COVERAGE: 90
    CYCLOMATIC_COMPLEXITY: 8
    COGNITIVE_COMPLEXITY: 12
    MAINTAINABILITY_INDEX: 85
    RESPONSE_TIME: 100
    MEMORY_USAGE: 100
    CPU_USAGE: 50

jobs:
  # ğŸ§ª TESTS - 100% PASS VERPLICHT
  tests:
    name: ğŸ§ª Tests - 100% Pass
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run Unit Tests
        id: unit_tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          npm run test:unit -- --coverage --watchAll=false --verbose
          echo "unit_status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ§ª Run Integration Tests
        id: integration_tests
        run: |
          echo "ğŸ§ª Running integration tests..."
          npm run test:integration -- --coverage --watchAll=false --verbose
          echo "integration_status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ§ª Run E2E Tests
        id: e2e_tests
        run: |
          echo "ğŸ§ª Running E2E tests..."
          npm run test:e2e -- --coverage --watchAll=false --verbose
          echo "e2e_status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Generate Test Coverage Report
        run: |
          echo "ğŸ“Š Generating coverage report..."
          npm run test:coverage

      - name: âœ… Validate Test Results
        run: |
          echo "âœ… Validating test results..."
          
          # Check if any tests failed
          if [ "${{ steps.unit_tests.outputs.unit_status }}" != "0" ]; then
            echo "âŒ Unit tests failed!"
            exit 1
          fi
          
          if [ "${{ steps.integration_tests.outputs.integration_status }}" != "0" ]; then
            echo "âŒ Integration tests failed!"
            exit 1
          fi
          
          if [ "${{ steps.e2e_tests.outputs.e2e_status }}" != "0" ]; then
            echo "âŒ E2E tests failed!"
            exit 1
          fi
          
          echo "âœ… All tests passed!"

  # ğŸ”’ SECURITY - 100% CLEAN VERPLICHT
  security:
    name: ğŸ”’ Security - 100% Clean
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”’ Security Scan
        id: security_scan
        run: |
          echo "ğŸ”’ Running security scan..."
          npm audit --audit-level=high
          echo "security_status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ”’ Dependency Check
        id: dependency_check
        run: |
          echo "ğŸ”’ Checking dependencies..."
          npm audit --audit-level=moderate
          echo "dependency_status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ”’ Code Security Scan
        id: code_security
        run: |
          echo "ğŸ”’ Scanning code for security issues..."
          # Add code security scanning tools here
          echo "code_security_status=0" >> $GITHUB_OUTPUT

      - name: âœ… Validate Security Results
        run: |
          echo "âœ… Validating security results..."
          
          if [ "${{ steps.security_scan.outputs.security_status }}" != "0" ]; then
            echo "âŒ Security scan failed!"
            exit 1
          fi
          
          if [ "${{ steps.dependency_check.outputs.dependency_status }}" != "0" ]; then
            echo "âŒ Dependency check failed!"
            exit 1
          fi
          
          if [ "${{ steps.code_security.outputs.code_security_status }}" != "0" ]; then
            echo "âŒ Code security scan failed!"
            exit 1
          fi
          
          echo "âœ… All security checks passed!"

  # ğŸ” CODE QUALITY - ZERO VIOLATIONS
  code_quality:
    name: ğŸ” Code Quality - Zero Violations
    runs-on: ubuntu-latest
    needs: [tests, security]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Linting Check
        id: linting
        run: |
          echo "ğŸ” Running linting..."
          npm run lint
          echo "linting_status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ” Complexity Analysis
        id: complexity
        run: |
          echo "ğŸ” Analyzing code complexity..."
          npm run complexity:check
          echo "complexity_status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ” Type Check
        id: type_check
        run: |
          echo "ğŸ” Running type check..."
          npm run type:check
          echo "type_status=$?" >> $GITHUB_OUTPUT

      - name: âœ… Validate Code Quality
        run: |
          echo "âœ… Validating code quality..."
          
          if [ "${{ steps.linting.outputs.linting_status }}" != "0" ]; then
            echo "âŒ Linting failed!"
            exit 1
          fi
          
          if [ "${{ steps.complexity.outputs.complexity_status }}" != "0" ]; then
            echo "âŒ Complexity check failed!"
            exit 1
          fi
          
          if [ "${{ steps.type_check.outputs.type_status }}" != "0" ]; then
            echo "âŒ Type check failed!"
            exit 1
          fi
          
          echo "âœ… All code quality checks passed!"

  # ğŸš€ BUILD & DEPLOYMENT - 100% SUCCESS
  build_deploy:
    name: ğŸš€ Build & Deployment - 100% Success
    runs-on: ubuntu-latest
    needs: [tests, security, code_quality]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Project
        id: build
        run: |
          echo "ğŸ—ï¸ Building project..."
          npm run build
          echo "build_status=$?" >> $GITHUB_OUTPUT

      - name: ğŸš€ Deploy to Preview
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/preview'
        environment: preview
        run: |
          echo "ğŸš€ Deploying to preview..."
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: ğŸš€ Deploy to Staging
        if: github.ref == 'refs/heads/preview'
        environment: staging
        run: |
          echo "ğŸš€ Deploying to staging..."
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: ğŸš€ Deploy to Production
        if: github.ref == 'refs/heads/main'
        environment: production
        run: |
          echo "ğŸš€ Deploying to production..."
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: âœ… Validate Deployment
        run: |
          echo "âœ… Validating deployment..."
          
          if [ "${{ steps.build.outputs.build_status }}" != "0" ]; then
            echo "âŒ Build failed!"
            exit 1
          fi
          
          echo "âœ… Build and deployment successful!"

  # ğŸ“Š QUALITY METRICS & REPORTING
  quality_reporting:
    name: ğŸ“Š Quality Metrics & Reporting
    runs-on: ubuntu-latest
    needs: [tests, security, code_quality, build_deploy]
    if: always()
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“Š Generate Quality Report
        run: |
          echo "ğŸ“Š Generating quality report..."
          
          # Test coverage
          echo "ğŸ§ª Test Coverage: $(npm run test:coverage --silent | grep -o '[0-9]\+%' | head -1)"
          
          # Security score
          echo "ğŸ”’ Security Score: $(npm audit --audit-level=high --silent | grep -c 'vulnerabilities' || echo '0') vulnerabilities"
          
          # Code quality
          echo "ğŸ” Code Quality: $(npm run lint --silent | grep -c 'error\|warning' || echo '0') violations"
          
          # Build status
          echo "ğŸš€ Build Status: ${{ needs.build_deploy.result }}"

      - name: ğŸ“¢ Quality Alert
        if: needs.tests.result == 'failure' || needs.security.result == 'failure' || needs.code_quality.result == 'failure' || needs.build_deploy.result == 'failure'
        run: |
          echo "ğŸš¨ QUALITY GATE FAILED!"
          echo "âŒ Tests: ${{ needs.tests.result }}"
          echo "âŒ Security: ${{ needs.security.result }}"
          echo "âŒ Code Quality: ${{ needs.code_quality.result }}"
          echo "âŒ Build & Deploy: ${{ needs.build_deploy.result }}"
          echo "ğŸš« DEPLOYMENT BLOCKED!"
          exit 1

      - name: âœ… Quality Gate Passed
        if: needs.tests.result == 'success' && needs.security.result == 'success' && needs.code_quality.result == 'success' && needs.build_deploy.result == 'success'
        run: |
          echo "âœ… QUALITY GATE PASSED!"
          echo "ğŸ§ª Tests: ${{ needs.tests.result }}"
          echo "ğŸ”’ Security: ${{ needs.security.result }}"
          echo "ğŸ” Code Quality: ${{ needs.code_quality.result }}"
          echo "ğŸš€ Build & Deploy: ${{ needs.build_deploy.result }}"
          echo "âœ… DEPLOYMENT APPROVED!"