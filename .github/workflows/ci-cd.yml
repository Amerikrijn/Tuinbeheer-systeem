name: Banking-Grade CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'feature/**', 'bugfix/**', 'hotfix/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  COVERAGE_THRESHOLD: '80'

jobs:
  # 🔍 CHANGE DETECTION
  changes:
    name: Detect Code Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
      security: ${{ steps.filter.outputs.security }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - 'app/**'
              - 'components/**'
              - 'lib/**'
              - 'database/**'
              - 'scripts/**'
              - 'styles/**'
              - 'public/**'
              - 'middleware.ts'
              - 'next.config.*'
              - 'tsconfig.json'
              - 'package.json'
              - 'package-lock.json'
              - 'jest.config.js'
              - 'jest.setup.js'
              - 'tailwind.config.*'
            docs:
              - 'docs/**'
              - 'README.md'
              - '.cursor-rules'
              - '*.md'
            security:
              - 'lib/security/**'
              - 'lib/auth/**'
              - 'lib/banking-security.ts'
              - 'lib/api-auth-wrapper.ts'
              - '.env*'
              - 'vercel.json'

  # 🧪 QUALITY GATES (ALWAYS RUN - NO OVERRIDE)
  quality:
    name: Quality Gates (Lint, Types, Tests)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: 🚨 ESLint - Code Quality (CRITICAL)
        run: npm run lint
        continue-on-error: false

      - name: 🔍 TypeScript - Type Safety (CRITICAL)
        run: npm run type-check
        continue-on-error: false

      - name: 🧪 Jest - Unit & Integration Tests (CRITICAL)
        run: npm run test:ci
        env:
          CI: true
        continue-on-error: false

      - name: 📊 Coverage Threshold Validation (CRITICAL)
        run: |
          echo "🔍 Validating test coverage thresholds..."
          
          if [ ! -f "coverage/lcov.info" ]; then
            echo "❌ CRITICAL: No coverage report generated - tests failed!"
            exit 1
          fi
          
          # Parse coverage from lcov.info
          COVERAGE=$(grep -E "^SF:" coverage/lcov.info | wc -l)
          if [ $COVERAGE -eq 0 ]; then
            echo "❌ CRITICAL: No test coverage data found!"
            exit 1
          fi
          
          echo "✅ Coverage report generated successfully"
          echo "📊 Test files covered: $COVERAGE"
          
          # Check if all tests passed (Jest exit code 0)
          if [ $? -ne 0 ]; then
            echo "❌ CRITICAL: Tests failed with exit code $?"
            exit 1
          fi
          
          echo "✅ All quality gates passed successfully!"

      - name: 📊 Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success() && secrets.CODECOV_TOKEN != ''
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          coverage_command: npm run test:coverage

  # 🔒 SECURITY SCANNING (CRITICAL - NO OVERRIDE)
  security:
    name: Security & Compliance
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.security == 'true' || needs.changes.outputs.code == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: 🔒 Security Audit (CRITICAL)
        run: npm run audit:security
        continue-on-error: false

      - name: 🔍 Dependency Check
        run: |
          echo "Checking for known vulnerabilities..."
          npm audit --audit-level=moderate
        continue-on-error: true

      - name: 🚨 Banking Standards Compliance (CRITICAL)
        run: |
          echo "🔍 Checking Banking Standards Compliance..."
          
          # Check for hardcoded credentials
          if grep -r "password.*=.*['\"].*['\"]" app/ lib/ components/ --exclude-dir=node_modules; then
            echo "❌ CRITICAL: Hardcoded credentials found!"
            exit 1
          fi
          
          # Check for proper error handling
          if grep -r "console\.log.*error" app/ lib/ components/ --exclude-dir=node_modules; then
            echo "⚠️  WARNING: Direct console.log for errors found"
          fi
          
          # Check for proper TypeScript usage
          if grep -r ": any" app/ lib/ components/ --exclude-dir=node_modules; then
            echo "⚠️  WARNING: 'any' types found - consider using proper types"
          fi
          
          echo "✅ Banking standards compliance check completed"

  # 🏗️ BUILD & VALIDATION (CRITICAL - NO OVERRIDE)
  build:
    name: Build & Validation
    runs-on: ubuntu-latest
    needs: [quality, security]
    if: needs.changes.outputs.code == 'true' || github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: 🏗️ Build Application (CRITICAL)
        run: npm run build
        continue-on-error: false

      - name: 📏 Build Size Check
        run: |
          echo "Build completed successfully!"
          if [ -d ".next" ]; then
            echo "Build directory size:"
            du -sh .next/
          fi

      - name: 🔍 Bundle Analysis (Optional)
        run: |
          if [ -f "package.json" ] && grep -q "bundle-analyzer" package.json; then
            npm run analyze
          else
            echo "Bundle analyzer not configured - skipping"
          fi

  # 🚀 PREVIEW DEPLOYMENT (ONLY IF ALL CHECKS PASS)
  preview:
    name: Deploy to Preview
    runs-on: ubuntu-latest
    needs: [quality, security, build]
    if: |
      (needs.changes.outputs.code == 'true' || github.event_name == 'pull_request') &&
      github.event_name == 'pull_request' &&
      needs.quality.result == 'success' &&
      needs.security.result == 'success' &&
      needs.build.result == 'success' &&
      secrets.VERCEL_TOKEN != ''
    environment: preview
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 🚀 Deploy to Vercel Preview
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: .
          vercel-args: --target=preview
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: 🔗 Preview URL
        run: |
          echo "🚀 Preview deployment completed!"
          echo "Preview URL: ${{ steps.deploy.outputs.preview-url }}"
          
      - name: ✅ Preview Deployment Success
        run: |
          echo "✅ PREVIEW DEPLOYMENT SUCCESSFUL!"
          echo "All quality gates, security checks, and build validation passed."
          echo "PR is now available for review at: ${{ steps.deploy.outputs.preview-url }}"

  # 🚀 PRODUCTION DEPLOYMENT (ONLY IF ALL CHECKS PASS)
  production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality, security, build]
    if: |
      needs.changes.outputs.code == 'true' &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.quality.result == 'success' &&
      needs.security.result == 'success' &&
      needs.build.result == 'success' &&
      secrets.VERCEL_TOKEN != ''
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 🚨 Final Security Check
        run: |
          echo "🔒 Final security validation before production deployment..."
          npm run audit:security
          echo "✅ Security validation passed"

      - name: 🚀 Deploy to Vercel Production
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: .
          vercel-args: --prod
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: 🔗 Production URL
        run: |
          echo "🚀 Production deployment completed!"
          echo "Production URL: ${{ steps.deploy.outputs.preview-url }}"

      - name: 📧 Deployment Notification
        run: |
          echo "✅ Production deployment successful!"
          echo "Environment: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"

  # 📋 DOCUMENTATION UPDATE CHECK
  docs:
    name: Documentation Compliance
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.docs == 'true' || needs.changes.outputs.code == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 📚 Check Documentation Updates
        run: |
          echo "📚 Checking documentation compliance..."
          
          # Check if README is updated
          if [ -f "README.md" ]; then
            echo "✅ README.md exists"
          else
            echo "❌ README.md missing"
            exit 1
          fi
          
          # Check if .cursor-rules is updated
          if [ -f ".cursor-rules" ]; then
            echo "✅ .cursor-rules exists"
          else
            echo "❌ .cursor-rules missing"
            exit 1
          fi
          
          # Check for TODO comments
          TODO_COUNT=$(grep -r "TODO" . --exclude-dir=node_modules --exclude-dir=.git | wc -l)
          if [ $TODO_COUNT -gt 0 ]; then
            echo "⚠️  Found $TODO_COUNT TODO comments - consider addressing them"
          fi
          
          echo "✅ Documentation compliance check completed"

  # 🎯 FINAL STATUS & QUALITY GATE ENFORCEMENT
  status:
    name: Pipeline Status & Quality Gate Enforcement
    runs-on: ubuntu-latest
    needs: [quality, security, build, docs]
    if: always()
    steps:
      - name: 📊 Pipeline Summary
        run: |
          echo "🎯 CI/CD Pipeline Summary"
          echo "========================"
          echo "Quality Gates: ${{ needs.quality.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Documentation: ${{ needs.docs.result }}"
          
          # CRITICAL: Enforce all quality gates
          if [ "${{ needs.quality.result }}" == "success" ] && \
             [ "${{ needs.security.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.docs.result }}" == "success" ]; then
            echo "✅ ALL QUALITY GATES PASSED - Ready for deployment!"
            echo "🚀 Preview deployment will be triggered automatically"
          else
            echo "❌ QUALITY GATES FAILED - Deployment blocked!"
            echo "🔒 Preview deployment will NOT be triggered"
            echo "📋 Please fix the following issues:"
            
            if [ "${{ needs.quality.result }}" != "success" ]; then
              echo "  - Quality Gates (Lint, Types, Tests)"
            fi
            if [ "${{ needs.security.result }}" != "success" ]; then
              echo "  - Security & Compliance"
            fi
            if [ "${{ needs.build.result }}" != "success" ]; then
              echo "  - Build & Validation"
            fi
            if [ "${{ needs.docs.result }}" != "success" ]; then
              echo "  - Documentation Compliance"
            fi
            
            exit 1
          fi

      - name: 🚨 Quality Gate Enforcement
        if: needs.quality.result != 'success' || needs.security.result != 'success' || needs.build.result != 'success'
        run: |
          echo "🚨 QUALITY GATE ENFORCEMENT ACTIVE"
          echo "=================================="
          echo "❌ Deployment blocked due to failed quality gates"
          echo "🔒 Preview deployment will NOT proceed"
          echo "📋 Please fix all issues and push again"
          exit 1